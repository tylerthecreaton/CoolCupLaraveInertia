### ระบบจัดการการคืนเงินและทรัพยากร (Refund & Resource Management)

**สรุปขั้นตอนและเงื่อนไขการคืนเงินสำหรับร้านกาแฟ**

---

#### 1. **ขั้นตอนการกดคืนเงิน**

-   **ปุ่มคืนเงิน**:
    -   พนักงาน/ระบบเลือกเหตุผลการคืนเงิน (Dropdown Menu) เช่น:
        -   สั่งผิดโดยพนักงาน
        -   ลูกค้ายกเลิก
        -   สินค้ามีปัญหา
        -   อื่น ๆ (ระบุในหมายเหตุ)
    -   ระบุ `Order ID` เพื่อตรวจสอบสถานะออเดอร์

---

#### 2. **ตรวจสอบสถานะออเดอร์**

| สถานะออเดอร์                              | คืนสต็อกได้ไหม? | การดำเนินการ                           |
| ----------------------------------------- | --------------- | -------------------------------------- |
| **ยังไม่เริ่มทำ** (Pending/Paid)          | ✅ ได้          | เพิ่มวัตถุดิบ (นม, กาแฟ) กลับเข้าสต็อก |
| **กำลังทำ/ทำเสร็จแล้ว** (Preparing/Ready) | ❌ ไม่ได้       | บันทึกหมายเหตุ: "วัตถุดิบถูกใช้ไปแล้ว" |

---

#### 3. **จัดการส่วนลด (Discount)**

-   **กรณีใช้ส่วนลดในออเดอร์**:
    -   คืนโควต้าส่วนลดให้ระบบ (ถ้าเป็นส่วนลดแบบครั้งเดียว/มีจำนวนจำกัด)
    -   **ตัวอย่าง**:
        -   หากใช้โค้ด "CAFE10" ให้เพิ่มโควต้ากลับ 1 ครั้ง
        -   หากเป็นโปรโมชัน "ซื้อ 1 แถม 1" ให้รีเซ็ตสถานะโปรโมชัน

---

#### 4. **จัดการ Point ของลูกค้า**

-   **กรณีลูกค้าใช้ Point**:
    -   คืน Point ที่ใช้ไปให้ลูกค้าเต็มจำนวน
    -   **ตัวอย่าง**:
        -   ออเดอร์ใช้ 50 Point → คืน 50 Point
-   **กรณีได้ Point จากการสั่งซื้อ**:
    -   หัก Point ที่เพิ่มให้ลูกค้าออก (หากยังไม่ได้ใช้)
    -   **ตัวอย่าง**:
        -   ออเดอร์ได้ 20 Point → หักออก 20 Point

---

### ตัวอย่างกระบวนการทั้งหมด

1. **เริ่มคืนเงิน**:
    - พนักงานกดปุ่ม "คืนเงิน" → เลือกเหตุผล → ระบุ Order ID
2. **ตรวจสอบสถานะ**:
    - ระบบตรวจสอบว่าออเดอร์ "กำลังทำ" หรือ "ยังไม่ทำ"
3. **คืนทรัพยากร (ถ้าเป็นไปได้)**:
    - หากยังไม่ทำ: เพิ่มสต็อก, คืนส่วนลด/Point
    - หากทำแล้ว: บันทึกหมายเหตุ "ไม่สามารถคืนสต็อกได้"
4. **คืนเงิน**:
    - เงินสด: บันทึกการคืนเงินในระบบ + ออกใบเสร็จ
    - บัตรเครดิต: ส่งคำขอคืนเงินผ่าน API (เช่น Stripe)
5. **บันทึกประวัติ**:
    - บันทึกเหตุผล, ผู้ดำเนินการ, เวลา, และทรัพยากรที่คืน

---

### ตัวอย่างข้อมูลใน Database

```sql
CREATE TABLE refunds (
    refund_id INT PRIMARY KEY,
    order_id INT,
    reason VARCHAR(255),
    is_restock_possible BOOLEAN,
    note TEXT,
    refunded_discount BOOLEAN,
    refunded_points INT,
    processed_by INT,
    created_at TIMESTAMP
);
```

---

### หมายเหตุสำคัญ

-   **การคืน Point/ส่วนลด**: ต้องตรวจสอบว่าลูกค้าไม่ได้ใช้ Point ที่คืนไปแล้วในการสั่งซื้ออื่น
-   **การแจ้งเตือน**: ส่งอีเมลหรือ SMS แจ้งลูกค้าหากคืนเงินผ่านช่องทางออนไลน์
-   **รายงาน**: สร้างรายงานประจำวันเพื่อตรวจสอบการคืนเงินและวัตถุดิบเสียหาย

ระบบนี้ช่วยให้ร้านกาแฟจัดการการคืนเงินได้อย่างโปร่งใส และลดข้อผิดพลาดจากมนุษย์ 👍☕


tinker command:

```bash
$permission = \Spatie\Permission\Models\Permission::create(['name' => 'manage settings']);

$admin = \Spatie\Permission\Models\Role::findByName('admin');
= Spatie\Permission\Models\Role {#5493
    id: 1,
    name: "admin",
    guard_name: "web",
    created_at: "2025-02-06 19:06:50",
    updated_at: "2025-02-06 19:06:50",
  }

> $admin->givePermissionTo(['manage settings']);
= Spatie\Permission\Models\Role {#5493
    id: 1,
    name: "admin",
    guard_name: "web",
    created_at: "2025-02-06 19:06:50",
    updated_at: "2025-02-06 19:06:50",
  }

```
